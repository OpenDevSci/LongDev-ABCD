"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var L=require("worker_threads"),d=require("../node-features-ecef9e7b.cjs"),D=require("module"),U=require("../source-map.cjs"),I=require("path"),f=require("url"),p=require("../index-5f60304b.cjs"),b=require("../resolve-ts-path-43f50656.cjs"),m=require("get-tsconfig"),x=require("fs");require("source-map-support"),require("esbuild"),require("crypto"),require("os");function P(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var A=P(D),v=P(I),M=P(x);const J=()=>{const{port1:e,port2:t}=new L.MessageChannel;U.installSourceMapSupport(e),process.send&&e.addListener("message",r=>{r.type==="dependency"&&process.send(r)}),e.unref(),A.default.register("./index.mjs",{parentURL:typeof document>"u"?new(require("url")).URL("file:"+__filename).href:document.currentScript&&document.currentScript.src||new URL("esm/index.cjs",document.baseURI).href,data:{port:t},transferList:[t]})},l=new Map;async function W(e){if(l.has(e))return l.get(e);if(!await M.default.promises.access(e).then(()=>!0,()=>!1)){l.set(e,void 0);return}const r=await M.default.promises.readFile(e,"utf8");try{const o=JSON.parse(r);return l.set(e,o),o}catch{throw new Error(`Error parsing: ${e}`)}}async function C(e){let t=new URL("package.json",e);for(;!t.pathname.endsWith("/node_modules/package.json");){const r=f.fileURLToPath(t),o=await W(r);if(o)return o;const s=t;if(t=new URL("../package.json",t),t.pathname===s.pathname)break}}async function K(e){var t;const r=await C(e);return(t=r==null?void 0:r.type)!=null?t:"commonjs"}const h=U.installSourceMapSupport(),g=process.env.ESBK_TSCONFIG_PATH?{path:v.default.resolve(process.env.ESBK_TSCONFIG_PATH),config:m.parseTsconfig(process.env.ESBK_TSCONFIG_PATH)}:m.getTsconfig(),j=g&&m.createFilesMatcher(g),k=g&&m.createPathsMatcher(g),E="file://",y=/\.([cm]?ts|[tj]sx)($|\?)/,R=/\.json(?:$|\?)/,B=e=>{const t=v.default.extname(e);if(t===".json")return"json";if(t===".mjs"||t===".mts")return"module";if(t===".cjs"||t===".cts")return"commonjs"},q=e=>{const t=B(e);if(t)return t;if(y.test(e))return K(e)},N=/\/(?:$|\?)/;let _,w=process.send?process.send.bind(process):void 0;const G=async e=>{if(!e)throw new Error(`tsx must be loaded with --import instead of --loader
The --loader flag was deprecated in Node v20.6.0`);const{port:t}=e;_=t,w=t.postMessage.bind(t)},H=({port:e})=>(_=e,w=e.postMessage.bind(e),`
	const require = getBuiltin('module').createRequire("${typeof document>"u"?new(require("url")).URL("file:"+__filename).href:document.currentScript&&document.currentScript.src||new URL("esm/index.cjs",document.baseURI).href}");
	require('tsx/source-map').installSourceMapSupport(port);
	if (process.send) {
		port.addListener('message', (message) => {
			if (message.type === 'dependency') {
				process.send(message);
			}
		});
	}
	port.unref(); // Allows process to exit without waiting for port to close
	`),T=async(e,t,r)=>{const o=await e(t,r);return!o.format&&o.url.startsWith(E)&&(o.format=await q(o.url)),o},z=[".js",".json",".ts",".tsx",".jsx"];async function S(e,t,r){const[o,s]=e.split("?");let i;for(const a of z)try{return await T(r,o+a+(s?`?${s}`:""),t)}catch(n){if(i===void 0&&n instanceof Error){const{message:c}=n;n.message=n.message.replace(`${a}'`,"'"),n.stack=n.stack.replace(c,n.message),i=n}}throw i}async function O(e,t,r){const o=N.test(e),s=o?"index":"/index",[i,a]=e.split("?");try{return await S(i+s+(a?`?${a}`:""),t,r)}catch(n){if(!o)try{return await S(e,t,r)}catch{}const c=n,{message:u}=c;throw c.message=c.message.replace(`${s.replace("/",v.default.sep)}'`,"'"),c.stack=c.stack.replace(u,c.message),c}}const Q=/^\.{1,2}\//,F=async function(e,t,r,o){var s;if(!d.supportsNodePrefix&&e.startsWith("node:")&&(e=e.slice(5)),N.test(e))return await O(e,t,r);const i=e.startsWith(E)||Q.test(e);if(k&&!i&&!((s=t.parentURL)!=null&&s.includes("/node_modules/"))){const a=k(e);for(const n of a)try{return await F(f.pathToFileURL(n).toString(),t,r)}catch{}}if(y.test(t.parentURL)){const a=b.resolveTsPath(e);if(a)for(const n of a)try{return await T(r,n,t)}catch(c){const{code:u}=c;if(u!=="ERR_MODULE_NOT_FOUND"&&u!=="ERR_PACKAGE_PATH_NOT_EXPORTED")throw c}}try{return await T(r,e,t)}catch(a){if(a instanceof Error&&!o){const{code:n}=a;if(n==="ERR_UNSUPPORTED_DIR_IMPORT")try{return await O(e,t,r)}catch(c){if(c.code!=="ERR_PACKAGE_IMPORT_NOT_DEFINED")throw c}if(n==="ERR_MODULE_NOT_FOUND")try{return await S(e,t,r)}catch{}}throw a}},X=async function(e,t,r){var o;w&&w({type:"dependency",path:e}),R.test(e)&&(t.importAssertions||(t.importAssertions={}),t.importAssertions.type="json");const s=await r(e,t);if(!s.source)return s;const i=e.startsWith("file://")?f.fileURLToPath(e):e,a=s.source.toString();if(s.format==="json"||y.test(e)){const n=await p.transform(a,i,{tsconfigRaw:(o=j)==null?void 0:o(i)});return{format:"module",source:h(n,e,_)}}if(s.format==="module"){const n=p.transformDynamicImport(i,a);n&&(s.source=h(n,e,_))}return s},$=async function(e,t,r){if(R.test(e))return{format:"module"};try{return await r(e,t,r)}catch(o){if(o.code==="ERR_UNKNOWN_FILE_EXTENSION"&&e.startsWith(E)){const s=await q(e);if(s)return{format:s}}throw o}},V=async function(e,t,r){var o;const{url:s}=t,i=s.startsWith("file://")?f.fileURLToPath(s):s;if(process.send&&process.send({type:"dependency",path:s}),R.test(s)||y.test(s)){const n=await p.transform(e.toString(),i,{tsconfigRaw:(o=j)==null?void 0:o(i)});return{source:h(n,s)}}const a=await r(e,t,r);if(t.format==="module"){const n=p.transformDynamicImport(i,a.source.toString());n&&(a.source=h(n,s))}return a},Y=d.nodeSupportsDeprecatedLoaders?$:void 0,Z=d.nodeSupportsDeprecatedLoaders?V:void 0;d.supportsModuleRegister&&L.isMainThread&&J(),exports.getFormat=Y,exports.globalPreload=H,exports.initialize=G,exports.load=X,exports.resolve=F,exports.transformSource=Z;
