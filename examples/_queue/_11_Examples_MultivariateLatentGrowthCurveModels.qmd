---
title: "Multivariate Latent Growth Curve Models"
author: "Biostatistics Working Group"
---

```{r}
#| echo: FALSE # The content of this code block will not be shown when rendered
#| output: FALSE # Output from this code block will not be shown when rendered

# This code configures knitr code chunk options

knitr::opts_chunk$set(
    echo = T, message = F, warning = F, error = F, output = T,
    comment = NA, cache = T, code_folding = T,
    R.options = list(width = 220, digits = 3),
    fig.align = "center",
    out.width = "75%", fig.asp = .75
)
```

```{r}
#| echo: FALSE # The content of this code block will not be shown when rendered
#| output: FALSE # Output from this code block will not be shown when rendered
#| cache: FALSE

# This code loads the data to be used for the example

library(tidyverse)

# Set the data path
data_path <- "/Users/shawes/ABCD/data/rds/abcd_5.0_rds/core-rds-5.0/non-imaging_excluding_nt_5.0.rds"

# Read the data
df <- readRDS(data_path)

# Create and mutate the dataframe
df_long <- df %>%
    select(src_subject_id, eventname, anthroheightcalc, anthroweightcalc) %>%
    filter(eventname %in% c("baseline_year_1_arm_1", "1_year_follow_up_y_arm_1", "2_year_follow_up_y_arm_1", "3_year_follow_up_y_arm_1")) %>%
    drop_na(anthroheightcalc, anthroweightcalc) %>%
    arrange(src_subject_id, eventname) %>%
    mutate(
        src_subject_id = factor(src_subject_id),
        eventname = factor(eventname, levels = c("baseline_year_1_arm_1", "1_year_follow_up_y_arm_1", "2_year_follow_up_y_arm_1", "3_year_follow_up_y_arm_1"), labels = c("Baseline", "Year_1", "Year_2", "Year_3")),
        anthroheightcalc = round(as.numeric(anthroheightcalc), 2),
        anthroweightcalc = round(as.numeric(anthroweightcalc), 2)
    ) %>%
    rename(
        id = src_subject_id,
        event = eventname,
        height = anthroheightcalc,
        weight = anthroweightcalc
    )

df_long <- df_long %>%
    group_by(id) %>%
    filter(all(c("Baseline", "Year_1", "Year_2", "Year_3") %in% event)) %>%
    ungroup()

```

## Overview

In this example, we will utilize xxxxxx models to analyze xxxxxx obtained across multiple measurement occasions for a sample of youth participating in the ABCD Study. Our primary objective is to understand xxxxxx, while factoring in the clustered nature of observations within individuals over time. XXXX models facilitate this by xxxxx.

## Preliminary Setup
### Load R libraries
```{r}
library(tidyverse)    # Collection of R packages for data science
library(rstatix)      # Pipe-friendly framework for basic statistical tests
library(DT)           # Rendering interactive data tables
library(lavaan)       #
```

### Descriptives
```{r}
descriptives_table <- df_long %>%
    select(event, height, weight) %>%
    mutate(event = factor(event)) %>%
    tbl_summary(
        by = event,
        missing = "no",
        label = list(height ~ "Height", weight ~ "Weight"),
        statistic = list(all_continuous() ~ "{mean} ({sd}) )", all_categorical() ~ "{p}%"),
    ) %>%
    modify_header(all_stat_cols() ~ "**{level}**<br>N = {n}") %>%
    bold_labels() %>%
    italicize_levels() %>%
    modify_spanning_header(all_stat_cols() ~ "**Assessment Wave**")
theme_gtsummary_compact()

descriptives_table
```

## Results
### Compute Multivariate Latent Growth Curve Model
This code performs multivariate latent growth curve to examine the reciprocal relationships between 'Height' and 'Weight' measurements across 3 annual visits. The model output is provided below, along with a summary of results. This approach xxxxx.

```{r}
# Reshape data from long to wide format
df_wide <- df_long %>%
    pivot_wider(
        id_cols = c(id),
        names_from = event,
        values_from = c(height, weight),
        names_sep = "_"
    )

df_wide <- na.omit(df_wide)

# Load necessary library
library(lavaan)

# Specify the multivariate latent growth curve model
model <- '
  # Intercept and slope factors for variable 1 (height)
  i_var1 =~ 1*height_Baseline + 1*height_Year_1 + 1*height_Year_2
  s_var1 =~ 0*height_Baseline + 1*height_Year_1 + 2*height_Year_2

  # Intercept and slope factors for variable 2 (weight)
  i_var2 =~ 1*weight_Baseline + 1*weight_Year_1 + 1*weight_Year_2
  s_var2 =~ 0*weight_Baseline + 1*weight_Year_1 + 2*weight_Year_2
'

# Fit the model using FIML for handling missing data
fit <- sem(model, data = df_wide, missing = "fiml")

# Check the summary to identify potential issues
summary(fit, fit.measures = TRUE, standardized = TRUE, rsquare = TRUE)

```

These results show xxxxx, indicating that xxxxx (e.g., xxxxx). The xxxx effects indicate xxxx.

### Model Plots
```{r}

```

This plot illustrates xxxx.

## Wrapping Up
The multivariate latent growth curve revealed xxxxxxxx.

